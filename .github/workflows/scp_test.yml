name: SCP Test

on:
  push:
    branches:
    - "scp_test"
  workflow_dispatch:

jobs:
  test-scp:
    runs-on: windows-latest
    steps:
      - name: Create a test file 
        run: |
          echo "This is a test file." > testfile.txt
          echo "version: 1.0.7" > latest.yml
          echo "files:" >> latest.yml
          echo "  - url: test.exe" >> latest.yml
          echo "    sha512: 3tx3ugvOwH2YISic6SNsyndVU7sZ1g5yZkA823fvbmZma34v9A3FydTO2Qf7F0ZomEKROEsuO5IvAe+wqkHGdA==" >> latest.yml    
        shell: pwsh

      # 修改windows加签后的yml文件
      - name: Calculate file hash
        if: ${{ runner.os == 'Windows' }}
        id: hash
        run: |
          $hash = (CertUtil -hashfile testfile.txt SHA512)[1] -replace ' ',''
          $base64 = [Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes($hash))
          echo "::set-output name=sha512_base64::$base64"

      # # 安装yq解析yml
      # - name: Install yq
      #   if: ${{ runner.os == 'Windows' }}
      #   run: |
      #     Invoke-WebRequest -Uri "https://github.com/mikefarah/yq/releases/download/v4.25.1/yq_windows_amd64.exe" -OutFile "yq.exe"
      #     New-Item -Path "C:\bin" -ItemType Directory -Force
      #     Move-Item -Path "yq.exe" -Destination "C:\bin\yq.exe"
      #   shell: powershell

      # - name: Extract, replace, and print hash value
      #   if: ${{ runner.os == 'Windows' }}
      #   run: |
      #     # Extract and print the old hash value
      #     $old_hash = & C:\bin\yq.exe e '.sha512' latest.yml
      #     Write-Output "Old Hash: $old_hash"
      #     Write-Output "New Hash: $env:new_hash"
      
      #     # Update the yaml file with the new hash
      #     & C:\bin\yq.exe e ".sha512 = `"$env:new_hash`"" -i latest.yml
          
      #     # Optionally, update hash in nested structure under 'files'
      #     & C:\bin\yq.exe e ".files[0].sha512 = `"$env:new_hash`"" -i latest.yml
      #   shell: powershell
      #   env:
      #     new_hash: ${{ steps.hash.outputs.sha512_base64 }}

      - name: Extract, replace, and print hash value
        if: ${{ runner.os == 'Windows' }}
        run: |
          # 引入 powershell-yaml 模块
          Import-Module powershell-yaml
          
          # 读取 YAML 文件
          $yamlContent = Get-Content -Path latest.yml -Raw | ConvertFrom-Yaml
          
          # 打印旧的 sha512 值
          Write-Output "Old Hash: $($yamlContent.sha512)"
          
          # 修改 sha512 值
          $yamlContent.sha512 = ${{ steps.hash.outputs.sha512_base64 }}
          
          # 可选：如果有嵌套的结构，如 files 数组
          $yamlContent.files[0].sha512 = ${{ steps.hash.outputs.sha512_base64 }}
          
          # 打印新的 sha512 值以确认
          Write-Output "New Hash: $($yamlContent.sha512)"
          
          # 将更改写回 YAML 文件
          $yamlContent | ConvertTo-Yaml | Set-Content -Path latest.yml

        shell: powershell

